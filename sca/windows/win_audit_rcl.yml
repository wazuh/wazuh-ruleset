# Security Configuration assessment
# Checks for Windows audit
# Copyright (C) 2015-2019, Wazuh Inc.
#
# This program is a free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#

policy:
  id: "win_audit"
  file: "win_audit_rcl.yml"
  name: "Benchmark for Windows audit"
  description: "This document provides a way of ensuring the security of the Windows systems."

requirements:
  title: "Check for Windows platform"
  description: "Requirements for running the audit policy under a Windows platform"
  condition: "any required"
  rules:
     - 'r:HKEY_LOCAL_MACHINE\SAM\SAM'

checks:
 - id: 2500
   title: "Ensure Registry tools set is enabled"
   compliance:
    - pci_dss: "10.6.1"
   condition: all
   rules:
     - 'r:HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System -> DisableRegistryTools'
     - 'r:HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System -> DisableRegistryTools -> 0'
 - id: 2501
   title: "Ensure DCOM is enabled"
   description: "The Distributed Component Object Model (DCOM) is a protocol that enables software components to communicate directly over a network."
   compliance:
    - pci_dss: "10.6.1"
   references:
    - https://support.microsoft.com/es-es/help/825750/how-to-disable-dcom-support-in-windows
   condition: all
   rules:
     - 'r:HKEY_LOCAL_MACHINE\Software\Microsoft\OLE -> EnableDCOM'
     - 'r:HKEY_LOCAL_MACHINE\Software\Microsoft\OLE -> EnableDCOM -> Y'
 - id: 2502
   title: "LM authentication allowed (disable weak passwords)"
   compliance:
    - pci_dss: "10.6.1, 11.4"
   condition: all
   rules:
     - 'r:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA -> LMCompatibilityLevel'
     - 'not r:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA -> LMCompatibilityLevel -> r:^0$|^1$'
# Disabled by some Malwares (sometimes by McAfee and Symantec
# security center too).
 - id: 2503
   title: "Ensure Firewall/Anti Virus notifications are enabled"
   compliance:
    - pci_dss: "10.6.1"
   condition: all
   rules:
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> FirewallDisableNotify'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> antivirusoverride'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> firewalldisablenotify'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> firewalldisableoverride'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> FirewallDisableNotify -> 0'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> antivirusoverride -> 0'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> firewalldisablenotify -> 0'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Security Center -> firewalldisableoverride -> 0'
# Checking for the microsoft firewall.
 - id: 2504
   title: "Ensure Microsoft Firewall is disabled"
   compliance:
    - pci_dss: "10.6.1, 1.4"
   condition: all
   rules:
     - 'r:HKEY_LOCAL_MACHINE\software\policies\microsoft\windowsfirewall\domainprofile -> enablefirewall'
     - 'r:HKEY_LOCAL_MACHINE\software\policies\microsoft\windowsfirewall\standardprofile -> enablefirewall'
     - 'r:HKEY_LOCAL_MACHINE\software\policies\microsoft\windowsfirewall\domainprofile -> enablefirewall -> 0'
     - 'r:HKEY_LOCAL_MACHINE\software\policies\microsoft\windowsfirewall\standardprofile -> enablefirewall -> 0'
 - id: 2505
   title: "Ensure Null sessions are disallowed"
   compliance:
    - pci_dss: "11.4"
   condition: all
   rules:
     - 'r:HKLM\System\CurrentControlSet\Control\Lsa -> RestrictAnonymous'
     - 'r:HKLM\System\CurrentControlSet\Control\Lsa -> RestrictAnonymous -> 1'
 - id: 2506
   title: "Ensure Error reporting is enabled"
   compliance:
    - pci_dss: "10.6.1"
   references:
    - https://windowsir.blogspot.com/2007/04/something-new-to-look-for.html
   condition: all
   rules:
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> DoReport'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeKernelFaults'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeMicrosoftApps'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeWindowsApps'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeShutdownErrs'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> ShowUI'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> DoReport -> 1'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeKernelFaults -> 1'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeMicrosoftApps -> 1'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeWindowsApps -> 1'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> IncludeShutdownErrs -> 1'
     - 'r:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PCHealth\ErrorReporting -> ShowUI -> 1'
 - id: 2507
   title: "Ensure Automatic Logon is disabled"
   compliance:
    - pci_dss: "10.6.1"
   condition: any
   rules:
     - 'not r:HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon -> DefaultPassword'
     - 'r:HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon -> AutoAdminLogon'
     - 'r:HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon -> AutoAdminLogon -> 0'
 - id: 2508
   title: "Ensure Winpcap packet filter driver is not present"
   compliance:
    - pci_dss: "10.6.1"
   condition: none
   rules:
     - 'f:%WINDIR%\System32\drivers\npf.sys'
     - 'f:%WINDIR%\Sysnative\drivers\npf.sys'
