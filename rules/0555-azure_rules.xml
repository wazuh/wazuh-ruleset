<!--
  -  Microsoft Azure ruleset
  -  Created by Wazuh, Inc.
  -  Copyright (C) 2015-2019, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
ID: 87800-87899
-->

<!--

#Log-analytics

{"Category": "Administrative", "ResourceProvider": "Microsoft.Compute", "ActivitySubstatus": "", "TenantId": "d6b...efa", "ActivityStatus": "Started", "Type": "AzureActivity", "Authorization": "{\r\n  \"action\": \"Microsoft.Compute/virtualMachines/start/action\",\r\n  \"scope\": \"/subscriptions/d17...6dd/resourceGroups/WazuhGroup/providers/Microsoft.Compute/virtualMachines/Logstash\"\r\n}", "OperationId": "d3ebb2e7-56d8-4927-bf83-01542e81c24f", "azure_tag": "azure-log-analytics", "ResourceId": "/subscriptions/d17...6dd/resourceGroups/WazuhGroup/providers/Microsoft.Compute/virtualMachines/Logstash", "OperationName": "Microsoft.Compute/virtualMachines/start/action", "Properties": "", "CorrelationId": "d3ebb2e7-56d8-4927-bf83-01542e81c24f", "HTTPRequest": "{\r\n  \"clientRequestId\": \"ce682d26-c7e5-4fac-94e2-824e208e1005\",\r\n  \"clientIpAddress\": \"83.49.98.225\",\r\n  \"method\": \"POST\"\r\n}", "log_analytics_tag": "azure-activity", "Resource": "Logstash", "Level": "Informational", "Caller": "sample@wazuh.com", "TimeGenerated": "2018-05-25T15:43:16.52Z", "ResourceGroup": "WazuhGroup", "SubscriptionId": "d17...6dd", "EventSubmissionTimestamp": "2018-05-25T15:43:36.109Z", "CallerIpAddress": "83.49.98.225", "EventDataId": "59bd108f-41ae-443a-8902-b654a72a8af7", "SourceSystem": "Azure"}

#Graph

{"activityType": "User", "internalCorrelationId": null, "activityDate": "2018-08-20T09:10:39.8707766Z", "activityResultDescription": "", "targets": [{"@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.TargetResourceUserEntity", "isPrivileged": null, "name": null, "objectId": "ca889c3a-47b3-4424-a7ac-f4c26f3c084c", "userSource": null, "userPrincipalName": "alfonso@wazuh.onmicrosoft.com", "modifiedProperties": [{"name": "Included Updated Properties", "oldValue": null, "newValue": "\"\""}, {"name": "TargetId.UserType", "oldValue": null, "newValue": "\"Member\""}], "puid": "10037FFEAB314424", "targetResourceType": "User", "ipAddress": null, "additionalDetails": null}], "correlationId": "be508521-5ee8-4de5-b4fc-2013eef65210", "category": "Core Directory", "azure_tag": "azure-ad-graph", "tenantGeolocation": null, "actor": {"@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.ActorUserEntity", "name": null, "objectId": "23bf7eb5-9593-4b58-ba50-b32ee01ccd4a", "userPrincipalName": "sample_wazuh.com#EXT#@wazuh.onmicrosoft.com", "puid": "10030000A8EFD7BB", "servicePrincipalName": null, "ipAddress": "<null>"}, "id": "Directory_7EPSJ_94874513", "source": null, "activityResultStatus": "Success", "componentOrSource": null, "additionalDetails": [{"name": "UserType", "value": "Member"}], "actorType": "User", "activityDateInMillis": 1534756239870, "activityOperationType": "Update", "domainName": null, "tenantId": "13fb6bf6-e9c2-4aeb-9957-f07dc32420e2", "tenantName": null, "azure_aad_tag": "azure-aad-activity", "activity": "Update user"}

#Storage json file

{"category": "Action", "azure_tag": "azure-storage", "level": "Information", "resourceId": "/SUBSCRIPTIONS/D17...6DD/RESOURCEGROUPS/WAZUHGROUP/PROVIDERS/MICROSOFT.STORAGE/STORAGEACCOUNTS/WAZUHGROUPDIAG665", "operationName": "MICROSOFT.STORAGE/STORAGEACCOUNTS/LISTKEYS/ACTION", "durationMs": 76, "properties": {"serviceRequestId": "bbcbafc4-31ed-428a-8536-0e8cea5c2721", "statusCode": "OK"}, "resultType": "Success", "resultSignature": "Succeeded.OK", "identity": {"claims": {"e_exp": "262800", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": "live.com#sample@wazuh.com", "altsecid": "1:live.com:0003BFFD0973B960", "http://schemas.microsoft.com/identity/claims/identityprovider": "live.com", "nbf": "1536323915", "ver": "1.0", "aud": "https://management.core.windows.net/", "ipaddr": "81.34.214.32", "puid": "10030000A8EFD7BB", "http://schemas.microsoft.com/identity/claims/objectidentifier": "23bf7eb5-9593-4b58-ba50-b32ee01ccd4a", "iat": "1536323915", "wids": "62e90394-69f5-4237-9190-012177145e10", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname": "Alberto", "http://schemas.microsoft.com/claims/authnclassreference": "1", "groups": "11945c43-21c2-48ed-8b08-3cf4d5e555a0", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname": "Rodriguez", "http://schemas.microsoft.com/claims/authnmethodsreferences": "pwd", "name": "Alberto Rodriguez", "iss": "https://sts.windows.net/13fb6bf6-e9c2-4aeb-9957-f07dc32420e2/", "uti": "u8xQmnOM90SO6ycx9uEZAA", "http://schemas.microsoft.com/identity/claims/tenantid": "13fb6bf6-e9c2-4aeb-9957-f07dc32420e2", "appidacr": "2", "aio": "42BgYMjYllx53Y9p6jonr52+M0XUtd9Urk5d4GfFYT69LV/j+zQA", "http://schemas.microsoft.com/identity/claims/scope": "user_impersonation", "exp": "1536327815", "appid": "c44b4083-3bb0-49c1-b47d-974e53cbdf3c", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "Xd-UHgPNe-zXWRAPp0BHTKBKQirFyjOd7ILS_RkjgfQ", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress": "sample@wazuh.com"}, "authorization": {"action": "Microsoft.Storage/storageAccounts/listKeys/action", "scope": "/subscriptions/d17...6dd/resourceGroups/WazuhGroup/providers/Microsoft.Storage/storageAccounts/wazuhgroupdiag665", "evidence": {"role": "Subscription Admin"}}}, "time": "2018-09-07T12:43:42.9696992Z", "azure_storage_tag": "activity", "callerIpAddress": "81.34.214.32", "correlationId": "c4b81795-7677-4a8e-ab76-20bbc9546f5d", "location": "global"}

-->
<group name="azure,">

  <rule id="87801" level="3">
    <decoded_as>json</decoded_as>
    <field name="azure_tag">azure-log-analytics</field>
    <description>Azure: Log analytics</description>
  </rule>

  <rule id="87802" level="3">
    <decoded_as>json</decoded_as>
    <field name="azure_tag">azure-ad-graph</field>
    <description>Azure: AD $(activity)</description>
  </rule>

  <rule id="87803" level="3">
    <decoded_as>json</decoded_as>
    <field name="azure_tag">azure-storage</field>
    <description>Azure: Storage</description>
  </rule>

  <rule id="87804" level="3">
    <decoded_as>azure-storage</decoded_as>
    <description>Azure: Storage</description>
  </rule>

  <rule id="87810" level="3">
    <if_sid>87801</if_sid>
    <field name="Type">AzureActivity</field>
    <description>Azure: Log analytics activity</description>
  </rule>

  <rule id="87811" level="3">
    <if_sid>87810</if_sid>
    <field name="OperationName">\.+</field>
    <description>Azure: Log analytics: $(OperationName)</description>
  </rule>

  <rule id="87813" level="3">
    <if_sid>87803</if_sid>
    <field name="operationName">\.+</field>
    <description>Azure: Storage: $(OperationName)</description>
  </rule>

</group>
